<!DOCTYPE html>
<html lang="en">
<head>
    <script src="runtime-config.js"></script>
    <script src="api.js"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - PF Creative AI Studio</title>
    
    <!-- Runtime configuration for API base - must be loaded BEFORE any other scripts -->
    <!-- Centralized env; must be loaded AFTER runtime-config.js -->
    <script src="env.js"></script>
    
                        <meta name="pf:apiBase" content="https://pfsystem-api-app-rjali3wdrq-as.a.run.app">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
    <style>
    :root{
      --bg-dark: #03020a;
      --panel: rgba(255,255,255,0.02);
      --glass-border: rgba(255,255,255,0.04);
      --muted: #9aa0ad;
      --gold-1: #ffd97a;
      --gold-2: #d6a200;
      --accent-dark: #2a1631;
      --accent-glow: rgba(214,162,0,0.06);
      --radius: 16px;
      --glass-blur: 18px;
      --max-width: 1280px;
      --shadow-strong: 0 40px 120px rgba(2,6,12,0.7);
    }

    html,body{
      height:100%;
      margin:0;
      background: radial-gradient(800px 500px at 8% 8%, rgba(214,162,0,0.02), transparent 10%),
                  radial-gradient(700px 500px at 92% 90%, rgba(139,92,246,0.02), transparent 12%),
                  linear-gradient(180deg,var(--bg-dark), #05020a 60%);
      color:#f1f4f8;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow-y:auto;
    }

    #bgCanvas { position:fixed; inset:0; width:100%; height:100%; z-index:0; display:block; }
    .bg-ornament { position:fixed; inset:0; pointer-events:none; z-index:1; mix-blend-mode:overlay; opacity:0.9; }

    .stage { max-width:var(--max-width); margin:40px auto; padding:36px 32px; position:relative; z-index:2; }

    header{display:flex;align-items:center;justify-content:space-between;gap:18px}
    .brand{display:flex;align-items:center;gap:14px}
    .logo{
      width:74px;height:74px;border-radius:18px;display:grid;place-items:center;color:white;
      background:linear-gradient(135deg,#3b1a6a,#b33e78 70%, #d6a200 100%);
      box-shadow:0 20px 60px rgba(139,92,246,0.12), inset 0 -8px 28px rgba(0,0,0,0.36);
      font-weight:800;font-family:Playfair Display,serif;font-size:22px;transition:transform .45s cubic-bezier(.2,.9,.3,1);
    }
    .logo:hover{transform:translateY(-6px) rotate(-2deg) scale(1.03)}
    .brand h1{margin:0;font-family:Playfair Display,serif;font-size:20px}
    .brand p{margin:0;color:var(--muted);font-size:13px}

    .controls{display:flex;align-items:center;gap:12px}
    .small-muted{color:var(--muted);font-size:13px}
    .badge{background:linear-gradient(90deg, rgba(214,162,0,0.12), rgba(255,255,255,0.02));padding:6px 10px;border-radius:999px;color:var(--gold-2);font-weight:700;font-size:12px;border:1px solid rgba(214,162,0,0.08)}
    .btn{border:0;padding:10px 16px;border-radius:12px;cursor:pointer;font-weight:700}
    .btn-primary{background:linear-gradient(90deg,#8b5cf6,#e25aa6);color:white;box-shadow:0 14px 36px rgba(139,92,246,0.12)}
    .btn-ghost{background:transparent;color:#f1f4f8;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px}

    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;margin-top:26px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02)); border-radius:var(--radius); padding:22px; border:1px solid var(--glass-border); backdrop-filter: blur(var(--glass-blur)); box-shadow:0 10px 40px rgba(6,8,14,0.6); position:relative; overflow:hidden; transition:transform .22s ease, box-shadow .22s ease;}
    .card::after{
      content:''; position:absolute; inset:-40% -20%; background:linear-gradient(120deg, rgba(214,162,0,0.015), transparent 18%); transform:rotate(18deg); pointer-events:none;
    }
    .label{color:var(--muted);font-size:13px;margin-bottom:8px}
    .value{font-weight:800;color:#fff;font-size:18px}

    .section-head{display:flex;align-items:center;justify-content:space-between;margin-top:32px}
    .plans{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-top:14px}
    .plan{
      position:relative;border-radius:18px;padding:24px;background:linear-gradient(180deg, rgba(139,92,246,0.02), rgba(0,0,0,0.02));border:1px solid rgba(255,255,255,0.03);overflow:hidden;transition:transform .22s cubic-bezier(.2,.9,.3,1),box-shadow .22s ease;
    }
    .plan:hover{transform:translateY(-14px) rotate(-0.3deg); box-shadow: var(--shadow-strong)}
    .plan .title{font-weight:800;font-size:15px;color:#fff}
    .plan .price{font-size:26px;font-weight:900;color:var(--gold-2);margin-top:6px; letter-spacing:0.4px}
    .plan .desc{color:var(--muted);margin-top:8px;font-size:13px}
    .plan .cta{margin-top:16px}
    .plan .ribbon{position:absolute;right:-52px;top:6px;transform:rotate(28deg);background:linear-gradient(90deg,#ffd98a,#e7b400);color:#241600;padding:7px 68px;border-radius:6px;font-weight:800;box-shadow:0 12px 34px rgba(214,162,0,0.08);font-size:12px}
    .plan .neon{position:absolute;left:-18%;top:-28%;width:160%;height:170%;transform:rotate(12deg);background:linear-gradient(90deg, rgba(214,162,0,0.02), rgba(139,92,246,0.02));mix-blend-mode:screen;pointer-events:none}
    .plan .gloss{position:absolute;right:-20px;bottom:-10px;width:260px;height:260px;filter:blur(60px);background:radial-gradient(circle at 30% 30%, rgba(255,255,255,0.02), transparent 40%);opacity:0.14}

    .projects{margin-top:28px}
    .p-list{display:grid;grid-template-columns:1fr;gap:12px}
    .project{padding:16px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.006));border:1px solid rgba(255,255,255,0.02)}

    .modal-backdrop{position:fixed;inset:0;background:rgba(2,4,8,0.6);display:none;align-items:center;justify-content:center;z-index:1200}
    .modal{width:460px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));border-radius:12px;padding:22px;border:1px solid rgba(255,255,255,0.06);box-shadow:0 30px 80px rgba(0,0,0,0.7)}
    .modal h3{margin:0 0 10px 0;font-size:18px}
    .modal .muted{font-size:13px;color:var(--muted);margin-bottom:14px}
    .modal .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:18px}

    footer{margin-top:56px;color:var(--muted);text-align:center;font-size:13px}

    .buyBtn{transition:transform .14s ease; border-radius:10px}
    .buyBtn:active{transform:translateY(2px)}
    .plan .price.small{font-size:18px}

    @media (max-width:1024px){ .plans{grid-template-columns:repeat(2,1fr)} .grid-3{grid-template-columns:1fr} }
    @media (max-width:640px){ .plans{grid-template-columns:1fr} .controls{flex-direction:column;gap:8px} .stage{padding:18px} .logo{width:56px;height:56px} .modal{width:92vw} }

    .api-indicator{font-size:12px;color:var(--muted);border:1px solid rgba(255,255,255,0.08);padding:6px 8px;border-radius:8px}
    .api-indicator.ok{color:#86efac;border-color:rgba(134,239,172,0.3)}
    .api-indicator.bad{color:#fca5a5;border-color:rgba(252,165,165,0.3)}
  </style>
</head>
<body>
  <canvas id="bgCanvas" aria-hidden="true"></canvas>

  <svg class="bg-ornament" aria-hidden="true" preserveAspectRatio="none" viewBox="0 0 1440 900" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <radialGradient id="v" cx="20%" cy="14%" r="80%"><stop offset="0" stop-color="#3b1a6a" stop-opacity="0.14"/><stop offset="1" stop-color="#000000" stop-opacity="0"/></radialGradient>
      <linearGradient id="goldline" x1="0" x2="1"><stop offset="0" stop-color="#ffd97a" stop-opacity="0.08"/><stop offset="1" stop-color="#d6a200" stop-opacity="0"/></linearGradient>
    </defs>
    <rect width="100%" height="100%" fill="url(#v)"/>
    <g fill="none" stroke="url(#goldline)" stroke-width="0.6" opacity="0.06">
      <path d="M0 400 Q200 300 400 400 T800 400 T1200 400 T1600 400"></path>
    </g>
  </svg>

  <main class="stage" role="main" aria-live="polite">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">PF</div>
        <div>
          <h1>PF Creative Studio</h1>
          <p class="small-muted">Welcome to your dashboard</p>
        </div>
      </div>
      <div class="controls" role="navigation" aria-label="User controls">
        <div id="headerUser" class="small-muted">—</div>
        <div class="badge" aria-hidden="true">Premium</div>
        <button id="toStudio" class="btn btn-primary">Open Studio</button>
        <button id="logoutBtn" class="btn-ghost">Logout</button>
      </div>
    </header>

    <section class="grid-3" aria-label="Account summary">
      <div class="card">
        <div class="label">Current Account</div>
        <div id="username" class="value">—</div>
      </div>
      <div class="card">
        <div class="label">Subscription Status</div>
        <div id="subStatus" class="value">—</div>
        <div id="subSince" class="small-muted" style="margin-top:10px"></div>
      </div>
      <div class="card">
        <div class="label">Expiry</div>
        <div id="expiry" class="value">—</div>
      </div>
    </section>

    <div class="section-head">
      <div>
        <h2 style="margin:0;font-size:18px">Packages</h2>
        <div class="small-muted" style="margin-top:6px">Choose a plan that fits your needs</div>
      </div>
      <div class="small-muted">Secure checkout • Billplz</div>
    </div>

    <div id="planContainer" class="plans" aria-live="polite"></div>

    <div class="section-head" style="margin-top:30px">
      <div>
        <h2 style="margin:0;font-size:18px">Recent Projects</h2>
        <div class="small-muted" style="margin-top:6px">Your latest creations</div>
      </div>
      <div class="small-muted">View all</div>
    </div>

    <div id="projects" class="projects" style="margin-top:14px">
      <div class="p-list"></div>
    </div>

    <footer>© PF Creative Studio</footer>
  </main>

  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <h3 id="modalTitle">Confirm Purchase</h3>
      <div id="modalBody" class="muted">Proceed to secure checkout.</div>
      <div class="modal-actions">
        <button id="modalCancel" class="btn-ghost">Cancel</button>
        <button id="modalConfirm" class="btn btn-primary">Proceed to Payment</button>
      </div>
    </div>
  </div>

  <script>
    // ========= Canvas background (kept) =========
    (function(){
      const canvas = document.getElementById('bgCanvas');
      const ctx = canvas.getContext('2d');
      const DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      function resize() {
        canvas.width = innerWidth * DPR;
        canvas.height = innerHeight * DPR;
        canvas.style.width = innerWidth + 'px';
        canvas.style.height = innerHeight + 'px';
        ctx.setTransform(DPR,0,0,DPR,0,0);
      }
      window.addEventListener('resize', resize);
      resize();

      const N = Math.max(18, Math.floor((innerWidth*innerHeight)/140000));
      const particles = [];
      for (let i=0;i<N;i++){
        particles.push({ x: Math.random()*innerWidth, y: Math.random()*innerHeight, r: 0.8 + Math.random()*2.6, vx: (Math.random()-0.5)*0.12, vy: (Math.random()-0.5)*0.12, hue: 40 + Math.random()*320, alpha: 0.06 + Math.random()*0.18 });
      }

      const streaks = [];
      for(let i=0;i<6;i++){
        streaks.push({ x: Math.random()*innerWidth*1.5 - innerWidth*0.25, y: Math.random()*innerHeight*1.5 - innerHeight*0.25, w: 180 + Math.random()*380, a: 0.02 + Math.random()*0.06, vx: -0.02 + (Math.random()-0.5)*0.06, vy: (Math.random()-0.5)*0.02, hue: 40 + Math.random()*40 });
      }

      function draw(){
        ctx.clearRect(0,0,innerWidth,innerHeight);
        const g = ctx.createLinearGradient(0,0,0,innerHeight);
        g.addColorStop(0, 'rgba(6,6,10,0.15)');
        g.addColorStop(1, 'rgba(1,1,1,0.6)');
        ctx.fillStyle = g;
        ctx.fillRect(0,0,innerWidth,innerHeight);

        for(const s of streaks){
          s.x += s.vx; s.y += s.vy;
          if(s.x < -innerWidth*0.5) s.x = innerWidth*1.2;
          if(s.x > innerWidth*1.2) s.x = -innerWidth*0.5;
          ctx.beginPath();
          const grd = ctx.createLinearGradient(s.x, s.y, s.x+s.w, s.y + s.w*0.08);
          grd.addColorStop(0, `hsla(${s.hue},70%,60%,${s.a})`);
          grd.addColorStop(0.5, `rgba(0,0,0,0)`);
          ctx.fillStyle = grd;
          if (!CanvasRenderingContext2D.prototype.roundRect) {
            CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
              if (w < 2 * r) r = w / 2;
              if (h < 2 * r) r = h / 2;
              this.beginPath();
              this.moveTo(x + r, y);
              this.arcTo(x + w, y, x + w, y + h, r);
              this.arcTo(x + w, y + h, x, y + h, r);
              this.arcTo(x, y + h, x, y, r);
              this.arcTo(x, y, x + w, y, r);
              this.closePath();
              return this;
            };
          }
          ctx.roundRect(s.x, s.y, s.w, 18, 18);
          ctx.fill();
        }

        for(const p of particles){
          p.x += p.vx; p.y += p.vy;
          p.vx += (Math.random()-0.5)*0.015;
          p.vy += (Math.random()-0.5)*0.015;
          if(p.x < -40) p.x = innerWidth + 40;
          if(p.x > innerWidth + 40) p.x = -40;
          if(p.y < -40) p.y = innerHeight + 40;
          if(p.y > innerHeight + 40) p.y = -40;

          ctx.beginPath();
          const g2 = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.r*8);
          g2.addColorStop(0, `hsla(40,80%,65%,${p.alpha})`);
          g2.addColorStop(1, 'rgba(0,0,0,0)');
          ctx.fillStyle = g2;
          ctx.arc(p.x, p.y, p.r*6, 0, Math.PI*2);
          ctx.fill();
        }

        for(let i=0;i<particles.length;i++){
          for(let j=i+1;j<particles.length;j++){
            const a=particles[i], b=particles[j];
            const dx=a.x-b.x, dy=a.y-b.y, d=Math.sqrt(dx*dx+dy*dy);
            if(d < 160){
              ctx.beginPath();
              ctx.moveTo(a.x,a.y);
              ctx.lineTo(b.x,b.y);
              ctx.strokeStyle = `rgba(214,162,0,${0.02*(1 - d/160)})`;
              ctx.lineWidth = 0.4;
              ctx.stroke();
            }
          }
        }
        requestAnimationFrame(draw);
      }
      draw();
    })();

    // ========= Main application logic (wrapped in IIFE) =========
      (function() {
      // ========= Backend base from runtime-config.js =========
      function getApiBase() {
        if (!window.__PF_RUNTIME__?.API_BASE) {
          throw new Error("PF runtime not initialized: API_BASE missing");
        }
        return window.__PF_RUNTIME__.API_BASE.replace(/\/+$/, "");
      }
      
      let API_BASE;
      try {
        API_BASE = getApiBase();
      } catch (e) {
        console.error("[PF][dashboard] Missing API base:", e.message);
        alert('Missing API base. Please contact admin to configure API settings.');
        return;
      }

      // ========= Token helpers =========
      function getToken(){ return localStorage.getItem('jwtToken') || localStorage.getItem('token') || null; }
      function clearAllTokens(){ localStorage.removeItem('jwtToken'); localStorage.removeItem('token'); localStorage.removeItem('username'); localStorage.removeItem('auth_ok'); }
      function setHeaderUser(text){ document.getElementById('headerUser').textContent = text || '—'; }

      // ========= Formatting & subscription extraction =========
      function formatExpiry(val){
      if(!val) return '—';
      try{
        if(/^[0-9]+$/.test(String(val))){
          if(String(val).length === 10) val = Number(val) * 1000;
          else val = Number(val);
        }
        const d = new Date(val);
        if(isNaN(d.getTime())) return String(val);
        return d.toLocaleString(undefined, { year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
      }catch(e){ return String(val); }
      }

      function extractSubscriptionInfo(data){
      const info = { active:false, since:null, expiry:null, raw:data };
      if(!data) return info;
      if(typeof data.is_subscribed === 'boolean') info.active = info.active || data.is_subscribed;
      if(typeof data.is_subscribed === 'string') info.active = info.active || (data.is_subscribed.toLowerCase() === 'true');
      if(data.subscription_expires_at) info.expiry = info.expiry || data.subscription_expires_at;
      if(typeof data.active === 'boolean') info.active = info.active || data.active;
      if(typeof data.subscribed === 'boolean') info.active = info.active || data.subscribed;
      if(typeof data.is_active === 'boolean') info.active = info.active || data.is_active;
      if(data.subscription){
        const sub = data.subscription;
        if(typeof sub.active === 'boolean') info.active = info.active || sub.active;
        if(sub.since) info.since = info.since || sub.since;
        if(sub.expires_at) info.expiry = info.expiry || sub.expires_at;
        if(sub.expiry) info.expiry = info.expiry || sub.expiry;
      }
      if(data.paid === true || data.paid === 'true') info.active = true;
      if(!info.expiry){
        info.expiry = data.expiry || data.expires_at || data.expiry_date || data.expiresAt || null;
      }
      if(!info.expiry && data.user && data.user.subscription && data.user.subscription.expires_at) info.expiry = data.user.subscription.expires_at;
      if(!info.since && data.since) info.since = data.since;
      return info;
      }

      function applySubscriptionInfo(info){
      document.getElementById('subStatus').textContent = info.active ? 'Active' : 'Inactive';
      document.getElementById('subSince').textContent = info.since ? ('Since: ' + formatExpiry(info.since)) : '';
      document.getElementById('expiry').textContent = info.expiry ? formatExpiry(info.expiry) : '—';
      }

      // ========= Plans & Projects =========
      const PLAN_WHITELIST = {
      p1m: { id:'p1m', name:'1 Month',  price:99,  description:'Monthly access to Pro features', rank:1 },
      p6m: { id:'p6m', name:'6 Months', price:198, description:'Save more with 6 months',        rank:2 },
      p12m:{ id:'p12m',name:'12 Months',price:297, description:'Best value — 12 months',        rank:3, recommended:true }
      };

      function normalizePlan(p){
      if(!p) return null;
      const id = String(p.id||'').toLowerCase();
      const name = String(p.name||'').toLowerCase();
      let months = null;
      const m1 = id.match(/(^|[^\d])(1|6|12)\s*m(onths?)?\b/);
      const m2 = name.match(/\b(1|6|12)\s*month(s)?\b/);
      const monthsMatch = (m1 && m1[2]) || (m2 && m2[1]);
      months = monthsMatch;
      if(!months){
        if(id in { 'p1m':1, '1m':1, 'monthly':1 }) months = '1';
        else if(id in { 'p6m':1, '6m':1 }) months = '6';
        else if(id in { 'p12m':1, '12m':1, 'year':1, 'annual':1 }) months = '12';
      }
      const key = months === '1' ? 'p1m' : months === '6' ? 'p6m' : months === '12' ? 'p12m' : null;
      if(!key) return null;
      const base = PLAN_WHITELIST[key];
      return { ...base, description: p.description || base.description || '' };
      }

      function renderPlans(plans){
      const container = document.getElementById('planContainer');
      container.innerHTML = '';

      let selected = [];
      if (Array.isArray(plans) && plans.length){
        const map = {};
        for(const raw of plans){
          const n = normalizePlan(raw);
          if(n) map[n.id] = n;
        }
        selected = ['p1m','p6m','p12m'].map(k => map[k] || PLAN_WHITELIST[k]);
      } else {
        selected = [PLAN_WHITELIST.p1m, PLAN_WHITELIST.p6m, PLAN_WHITELIST.p12m];
      }

      selected.sort((a,b)=> (a.rank||0) - (b.rank||0));

      selected.forEach((p, idx) => {
        const el = document.createElement('div');
        el.className = 'plan';
        const ribbon = (p.recommended || p.id==='p12m' || idx===2) ? `<div class="ribbon" aria-hidden="true">RECOMMENDED</div>` : '';
        el.innerHTML = `
          <div class="neon" aria-hidden="true"></div>
          ${ribbon}
          <div class="title">${p.name}</div>
          <div class="price">RM${p.price}</div>
          <div class="desc">${p.description || ''}</div>
          <div class="cta"><button class="btn btn-primary buyBtn" data-plan="${p.id}" data-name="${(p.name||'Plan')}" data-price="${p.price}">Buy</button></div>
          <div class="gloss" aria-hidden="true"></div>
        `;
        container.appendChild(el);
      });
      }

      function renderProjects(items){
      const list = document.querySelector('#projects .p-list');
      list.innerHTML = '';
      if(!Array.isArray(items) || items.length === 0){
        const empty = document.createElement('div');
        empty.className = 'project';
        empty.innerHTML = `<div class="title">No projects yet</div><div class="small-muted">Create your first video in the Studio</div>`;
        list.appendChild(empty);
        return;
      }
      items.forEach(i=>{
        const e = document.createElement('div');
        e.className = 'project';
        e.innerHTML = `<div class="title">${i.title || 'Untitled'}</div><div class="small-muted">${i.updated_at || ''}</div>`;
        list.appendChild(e);
      });
      }

      // ========= Modal & purchase =========
      const modalBackdrop = document.getElementById('modalBackdrop');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');
      const modalConfirm = document.getElementById('modalConfirm');
      const modalCancel = document.getElementById('modalCancel');
      let pendingPlan = null;

      function openModal(plan){
      pendingPlan = plan;
      modalTitle.textContent = `Purchase ${plan.name}`;
      modalBody.textContent = `Proceed to pay RM${plan.price} for \"${plan.name}\"? You will be redirected to secure checkout.`;
      modalBackdrop.style.display = 'flex';
      modalBackdrop.setAttribute('aria-hidden','false');
      modalConfirm.focus();
      }
      function closeModal(){ pendingPlan = null; modalBackdrop.style.display='none'; modalBackdrop.setAttribute('aria-hidden','true'); }
      modalCancel.addEventListener('click', closeModal);
      modalBackdrop.addEventListener('click', (e)=> { if(e.target === modalBackdrop) closeModal(); });
      document.addEventListener('keydown', (e)=> { if(e.key === 'Escape') closeModal(); });

      modalConfirm.addEventListener('click', async () => {
      if(!pendingPlan) return closeModal();
      const token = getToken();
      if(!token){ clearAllTokens(); window.location.href='login.html'; return; }
      try{
        modalConfirm.disabled = true; modalConfirm.textContent = 'Redirecting…';
        const resp = await window.apiFetch('/create-bill', {
          method:'POST',
          headers:{ 'Authorization':'Bearer ' + token },
          body: JSON.stringify({ plan: pendingPlan.id })
        });
        const data = await resp.json().catch(()=>({}));
        if(!resp.ok){ alert(data.error || data.detail || 'Failed to create bill.'); closeModal(); modalConfirm.disabled=false; modalConfirm.textContent='Proceed to Payment'; return; }
        if(data.url){ window.location.href = data.url; } else { alert('No checkout URL returned.'); closeModal(); modalConfirm.disabled=false; modalConfirm.textContent='Proceed to Payment'; }
      }catch(e){
        console.error('create-bill error', e);
        alert('Network error when creating bill. Please try again.');
        closeModal(); modalConfirm.disabled=false; modalConfirm.textContent='Proceed to Payment';
      }
      });

      function bindBuyButtons(){
      document.getElementById('planContainer').addEventListener('click', (e) => {
        const btn = e.target.closest('.buyBtn');
        if(!btn) return;
        const plan = { id: btn.dataset.plan, name: btn.dataset.name, price: btn.dataset.price };
        openModal(plan);
      });
      }

      // ========= Auth & initial load =========
      async function ensureLoginAndStatus(){
      const token = getToken();
      const username = localStorage.getItem('username');
      if(!token || !username){ clearAllTokens(); window.location.href = 'login.html?expired=1'; return false; }
      document.getElementById('username').textContent = username;
      setHeaderUser(username);

      if(!API_BASE){
        alert('API base is not set. Please contact admin.');
        return false;
      }

      try{
        const resp = await window.apiFetch('/get-user-status', { method:'GET', headers:{ 'Authorization':'Bearer ' + token }});
        if(resp.status === 401){ clearAllTokens(); window.location.href='login.html?expired=1'; return false; }
        if(!resp.ok){ console.warn('auth check non-ok', resp.status); return true; }
        const data = await resp.json().catch(()=>null);
        if(data && data.username){ document.getElementById('username').textContent = data.username; setHeaderUser(data.username); localStorage.setItem('username', data.username); }
        const sub = extractSubscriptionInfo(data);
        applySubscriptionInfo(sub);
        return true;
      }catch(e){
        console.warn('auth check failed', e);
        return true;
      }
      }

      (async function init(){
      const ok = await ensureLoginAndStatus();
      if(!ok) return;
      bindBuyButtons();

      const token = getToken();

      try{
        const r = await window.apiFetch('/v1/plans', { method:'GET', headers:{ 'Authorization':'Bearer ' + token }});
        if(r.ok){ const plans = await r.json().catch(()=>null); renderPlans(plans); } else renderPlans(null);
      }catch(e){ console.warn('plans fetch failed', e); renderPlans(null); }

      try{
        const r = await window.apiFetch('/v1/projects?recent=6', { method:'GET', headers:{ 'Authorization':'Bearer ' + token }});
        if(r.ok){ const projects = await r.json().catch(()=>[]); renderProjects(projects); } else renderProjects([]);
      }catch(e){ console.warn('projects fetch failed', e); renderProjects([]); }

      setInterval(async () => {
        try{
          const t = getToken();
          if(!t) return;
          const r = await window.apiFetch('/get-user-status', { method:'GET', headers:{ 'Authorization':'Bearer ' + t }});
          if(r.status === 401){ clearAllTokens(); window.location.href='login.html?expired=1'; return; }
          if(!r.ok) return;
          const data = await r.json().catch(()=>null);
          const s = extractSubscriptionInfo(data);
          applySubscriptionInfo(s);
          if(data && data.username){ document.getElementById('username').textContent = data.username; setHeaderUser(data.username); localStorage.setItem('username', data.username); }
        }catch(e){ console.warn('auto-refresh failed', e); }
      }, 30000);

      })();

      document.getElementById('logoutBtn').addEventListener('click', () => { clearAllTokens(); window.location.href='login.html'; });
      document.getElementById('toStudio').addEventListener('click', () => { if(getToken()) window.location.href='chatroom.html'; else { clearAllTokens(); window.location.href='login.html'; } });
      })(); // Close IIFE
  </script>
</body>
</html>